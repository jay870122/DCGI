<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garbled å¹»å½©æ°´æ™¶å•†åº—</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2C2F33; color: white; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
    .card { background-color: #23272A; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.6); position: relative; }
    .btn { color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; width: 100%; display: inline-block; box-sizing: border-box; text-decoration: none; }
    .btn-login { background-color: #5865F2; margin-top: 10px; }
    .btn-login:hover { background-color: #4752C4; }
    .btn-logout { background-color: #ED4245; margin-top: 20px; }
    .btn-logout:hover { background-color: #C13537; }
    .btn-refresh { background-color: #4F545C; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.3s; }
    .btn-refresh:hover { background-color: #686D73; }
    .btn-refresh:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #5865F2; margin-bottom: 10px; }
    .score-box { background-color: #2C2F33; padding: 15px; border-radius: 8px; text-align: left; margin-bottom: 20px; }
    .score-item { display: flex; justify-content: space-between; font-size: 16px; margin: 8px 0; padding-bottom: 6px; border-bottom: 1px solid #4F545C; }
    .score-value { font-weight: bold; color: #58FF9C; }
    .dynamic-score-value { font-weight: bold; color: #FEE75C; } 
    
    .controls-container { display: flex; gap: 10px; margin-bottom: 15px; }
    .shop-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #4F545C; background-color: #2C2F33; color: white; font-size: 14px; outline: none; }
    
    .shop-list-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .shop-item-card { background-color: #2F3136; border: 1px solid #4F545C; border-radius: 8px; padding: 15px; text-align: left; position: relative; }
    .shop-item-card.disabled { opacity: 0.6; }
    .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #40444B; padding-bottom: 8px;}
    .item-name { font-size: 18px; font-weight: bold; color: #FFF; }
    .item-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .badge-avail { background-color: #43B581; color: white; }
    .badge-unavail { background-color: #ED4245; color: white; }
    .item-info { font-size: 14px; color: #B9BBBE; margin-bottom: 12px; line-height: 1.6; }
    .item-price { color: #FEE75C; font-weight: bold; font-size: 16px; }
    
    .limit-tags { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .limit-tag { font-size: 12px; padding: 4px 8px; border-radius: 4px; display: inline-block; width: fit-content; }
    .tag-global { background-color: #4F545C; color: #FFF; }
    .tag-personal { background-color: #5865F2; color: #FFF; }
    .tag-total { background-color: #FEE75C; color: #000; font-weight: bold; }

    .item-actions { display: flex; gap: 10px; align-items: center; }
    .qty-input { width: 70px; padding: 8px; border-radius: 6px; border: 1px solid #4F545C; background-color: #202225; color: white; font-size: 16px; text-align: center; outline: none; }
    .btn-buy { background-color: #43B581; padding: 8px 16px; width: auto; flex-grow: 1; }
    .btn-buy:hover { background-color: #3CA374; }
    .btn-buy:disabled { background-color: #4F545C; cursor: not-allowed; }

    .version-tag { font-size: 12px; color: #72767D; margin-top: 20px; text-align: center; }
    #dashboard, #loading { display: none; }
  </style>
</head>
<body>

  <div class="card">
    <h1 style="margin-top:0;">Garbled å¹»å½©æ°´æ™¶å•†åº—</h1>
    
    <div id="login-section">
      <p style="color: #B9BBBE;">è«‹ç¶å®šæ‚¨çš„ Discord å¸³è™Ÿä»¥æŸ¥çœ‹è³‡æ–™èˆ‡å…Œæ›</p>
      <a href="https://discord.com/api/oauth2/authorize?client_id=1365601646448607335&redirect_uri=https%3A%2F%2Fjay870122.github.io%2FDCGI%2F&response_type=token&scope=identify" class="btn btn-login">ğŸ® ä½¿ç”¨ Discord ç™»å…¥</a>
    </div>

    <div id="loading">
      <p id="loading-text">â³ æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>
    </div>

    <div id="dashboard">
      <img id="user-avatar" class="avatar" src="" alt="Avatar">
      <h2 id="user-name" style="margin-top:0;">ç©å®¶åç¨±</h2>
      
      <div class="score-box" id="score-box-container">
        <div class="score-item"><span>ğŸŒŸ ç¸½ç²å¾—å¹»å½©æ°´æ™¶:</span> <span class="score-value" id="score-s1">0</span></div>
        <div class="score-item"><span>ğŸ”¥ å¯ç”¨å¹»å½©æ°´æ™¶:</span> <span class="score-value" id="score-s2">0</span></div>
        <div class="score-item" id="score-s3-container"><span>ğŸ’ é»æ•¸3:</span> <span class="score-value" id="score-s3">0</span></div>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0;">ğŸ›’ å…Œæ›å•†åº—</h3>
        <button id="btn-refresh" class="btn-refresh" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>

      <div class="controls-container">
        <select id="filter-category" class="shop-input" onchange="renderShop()">
          <option value="all">ğŸ“ æ‰€æœ‰åˆ†é¡</option>
        </select>
        <select id="sort-items" class="shop-input" onchange="renderShop()">
          <option value="default">é è¨­æ’åº</option>
          <option value="avail-first">âœ… å¯ç”¨å„ªå…ˆ</option>
          <option value="a-z">ğŸ”  åç¨± A ~ Z</option>
          <option value="z-a">ğŸ”¡ åç¨± Z ~ A</option>
          <option value="price-low">ğŸ’° åƒ¹æ ¼ ä½ ~ é«˜</option>
          <option value="price-high">ğŸ’° åƒ¹æ ¼ é«˜ ~ ä½</option>
        </select>
      </div>
      
      <div id="shop-list" class="shop-list-container"></div>
      <button class="btn btn-logout" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <div class="version-tag">ç³»çµ±ç‰ˆæœ¬ï¼šv1.7.0 (å¤šå¹£ç¨®æ”¯æ´ç‰ˆ)</div>
  </div>

  <script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzBie8G4KRouJ3nQMsGccDxI0pPlm-kh3Sg8GsURORsRHFCyJgtKV5mJ4A7wKWEo8W1wQ/exec';
    let currentUser = null; 
    let currentShopItems = []; 

    window.onload = () => {
      const hashString = window.location.hash.slice(1);
      if (!hashString) return; 

      const fragment = new URLSearchParams(hashString);
      const accessToken = fragment.get('access_token');
      const tokenType = fragment.get('token_type');

      if (accessToken) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        window.history.replaceState(null, null, window.location.pathname);

        fetch('https://discord.com/api/users/@me', { headers: { authorization: `${tokenType} ${accessToken}` } })
        .then(res => res.json())
        .then(user => {
          currentUser = user; 
          document.getElementById('user-name').innerText = user.global_name || user.username;
          document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
          fetchScoresAndShop(user.id);
        }).catch(err => {
          alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
          window.location.reload();
        });
      }
    };

    function refreshData() {
      if(!currentUser) return;
      const refreshBtn = document.getElementById('btn-refresh');
      refreshBtn.innerText = "â³ è®€å–ä¸­...";
      refreshBtn.disabled = true;
      fetchScoresAndShop(currentUser.id, () => {
        refreshBtn.innerText = "ğŸ”„ é‡æ–°æ•´ç†";
        refreshBtn.disabled = false;
      });
    }

    function fetchScoresAndShop(discordId, callback = null) {
      document.getElementById('loading-text').innerText = "â³ è¼‰å…¥åˆ†æ•¸èˆ‡å•†åº—ç›®éŒ„...";
      
      let p1 = fetch(`${GAS_API_URL}?action=getScores&discordId=${discordId}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          document.getElementById('score-s1').innerText = data.s1;
          document.getElementById('score-s2').innerText = data.s2;
          document.getElementById('score-s3').innerText = data.s3;
          if (parseInt(data.s3) === 0) document.getElementById('score-s3-container').style.display = 'none';
          else document.getElementById('score-s3-container').style.display = 'flex';

          document.querySelectorAll('.dynamic-score-item').forEach(e => e.remove());

          if(data.customVars && data.customVars.length > 0) {
            const container = document.getElementById('score-box-container');
            data.customVars.forEach(v => {
              const html = `<div class="score-item dynamic-score-item"><span>ğŸ’  ${v.display}:</span> <span class="dynamic-score-value">${v.value}</span></div>`;
              container.insertAdjacentHTML('beforeend', html);
            });
          }
        }
      });

      let p2 = fetch(`${GAS_API_URL}?action=getShop&discordId=${discordId}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          currentShopItems = data.items;
          const catSet = new Set(currentShopItems.map(item => item.category));
          const catSelect = document.getElementById('filter-category');
          const currentSelection = catSelect.value; 
          catSelect.innerHTML = '<option value="all">ğŸ“ æ‰€æœ‰åˆ†é¡</option>';
          catSet.forEach(cat => {
            let selected = (cat === currentSelection) ? 'selected' : '';
            catSelect.innerHTML += `<option value="${cat}" ${selected}>${cat}</option>`;
          });

          renderShop();
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        }
      });

      Promise.all([p1, p2]).then(() => { if(callback) callback(); });
    }

    function renderShop() {
      const container = document.getElementById('shop-list');
      const filterCat = document.getElementById('filter-category').value;
      const sortType = document.getElementById('sort-items').value;
      let displayItems = [...currentShopItems];

      if (filterCat !== 'all') displayItems = displayItems.filter(item => item.category === filterCat);

      if (sortType === 'avail-first') {
        displayItems.sort((a, b) => {
          if (a.state === 'available' && b.state !== 'available') return -1;
          if (a.state !== 'available' && b.state === 'available') return 1;
          return 0;
        });
      } else if (sortType === 'a-z') displayItems.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
      else if (sortType === 'z-a') displayItems.sort((a, b) => b.name.localeCompare(a.name, 'zh-TW'));
      else if (sortType === 'price-low') displayItems.sort((a, b) => a.price - b.price);
      else if (sortType === 'price-high') displayItems.sort((a, b) => b.price - a.price);

      container.innerHTML = "";
      if (displayItems.length === 0) {
        container.innerHTML = "<div style='color:#B9BBBE; text-align:center;'>ç›®å‰ç„¡ç¬¦åˆæ¢ä»¶çš„å•†å“</div>";
        return;
      }

      displayItems.forEach((item) => {
        const isAvail = item.state === "available";
        const badgeClass = isAvail ? "badge-avail" : "badge-unavail";
        const safeId = encodeURIComponent(item.name).replace(/%/g, ''); 
        
        let limitsHtml = `<div class="limit-tags">`;
        if (item.limits.remainGD !== null) limitsHtml += `<span class="limit-tag tag-global">ğŸŒ å…¨æœä»Šæ—¥å‰©é¤˜: ${item.limits.remainGD}</span>`;
        if (item.limits.remainGM !== null) limitsHtml += `<span class="limit-tag tag-global">ğŸŒ å…¨æœæœ¬æœˆå‰©é¤˜: ${item.limits.remainGM}</span>`;
        if (item.limits.remainPD !== null) limitsHtml += `<span class="limit-tag tag-personal">ğŸ‘¤ å€‹äººä»Šæ—¥å‰©é¤˜: ${item.limits.remainPD}</span>`;
        if (item.limits.remainPM !== null) limitsHtml += `<span class="limit-tag tag-personal">ğŸ‘¤ å€‹äººæœ¬æœˆå‰©é¤˜: ${item.limits.remainPM}</span>`;
        if (item.limits.remainPT !== null) limitsHtml += `<span class="limit-tag tag-total">ğŸ‘‘ å¸³è™Ÿçµ‚èº«å‰©é¤˜: ${item.limits.remainPT}</span>`;
        limitsHtml += `</div>`;
        if (limitsHtml === `<div class="limit-tags"></div>`) limitsHtml = ""; 

        let actionHtml = '';
        if (isAvail) {
          let maxQty = item.limits.effectiveStock !== "ç„¡é™" ? item.limits.effectiveStock : 999;
          actionHtml = `
            <div class="item-actions">
              <input type="number" id="qty-${safeId}" class="qty-input" value="1" min="1" max="${maxQty}">
              <button id="btn-${safeId}" class="btn btn-buy" onclick="buyItem('${item.name}', '${safeId}', ${maxQty}, '${item.displayCurrency}')">å…Œæ›</button>
            </div>
          `;
        } else {
          actionHtml = `<button class="btn btn-buy" disabled>ç„¡æ³•å…Œæ›</button>`;
        }

        // ğŸŒŸ åƒ¹æ ¼é¡¯ç¤ºå‹•æ…‹è²¨å¹£ï¼
        const html = `
          <div class="shop-item-card ${!isAvail ? 'disabled' : ''}">
            <div class="item-header">
              <span class="item-name">${item.name}</span>
              <span class="item-badge ${badgeClass}">${item.stateMsg}</span>
            </div>
            <div class="item-info">
              ğŸ“ åˆ†é¡ï¼š<span style="color: #A6D189; font-weight: bold;">${item.category}</span><br>
              ğŸ’° åƒ¹æ ¼ï¼š<span class="item-price">${item.price} ${item.displayCurrency}</span><br>
              ğŸ“¦ ç¸½åº«å­˜ï¼š${item.limits.baseStock}
              ${limitsHtml}
            </div>
            ${actionHtml}
          </div>
        `;
        container.innerHTML += html;
      });
    }

    // ğŸŒŸ è³¼è²·é‚è¼¯åŠ å…¥å‹•æ…‹è²¨å¹£åç¨±
    function buyItem(itemName, safeId, maxQty, currencyName) {
      if (!currentUser) return;
      const qtyInput = document.getElementById(`qty-${safeId}`);
      const qty = parseInt(qtyInput.value);
      
      if (qty < 1) { alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼"); return; }
      if (qty > maxQty) { alert(`å·²è¶…éé™è³¼æ•¸é‡ï¼æ‚¨ç›®å‰æœ€å¤šåªèƒ½è²· ${maxQty} å€‹ã€‚`); return; }
      
      // ğŸŒŸ ç¢ºèªè¦–çª—æœƒç²¾æº–é¡¯ç¤ºè¦æ‰£å“ªç¨®è²¨å¹£ï¼
      if (!confirm(`ç¢ºå®šè¦èŠ±è²» ${currencyName} å…Œæ› ${qty} å€‹ ${itemName} å—ï¼Ÿ`)) return;

      const btn = document.getElementById(`btn-${safeId}`);
      btn.innerText = "â³ è™•ç†ä¸­...";
      btn.disabled = true;

      fetch(`${GAS_API_URL}?action=buy&discordId=${currentUser.id}&itemName=${encodeURIComponent(itemName)}&qty=${qty}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          alert("âœ… " + data.message);
          // å› ç‚ºå¯èƒ½æ‰£çš„æ˜¯åˆ¥ç¨®è²¨å¹£ï¼Œæœ€å®‰å…¨çš„æ–¹å¼æ˜¯æ•´é é‡æ–°æŠ“å–ä¸€æ¬¡è³‡æ–™
          fetchScoresAndShop(currentUser.id); 
        } else {
          alert("âŒ å…Œæ›å¤±æ•—ï¼š" + data.message);
        }
      })
      .catch(err => alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼"))
      .finally(() => {
        btn.innerText = "å…Œæ›";
        btn.disabled = false;
      });
    }

    function logout() { window.location.href = "https://jay870122.github.io/DCGI/"; }
  </script>
</body>
</html>
