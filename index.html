<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©å®¶é»æ•¸èˆ‡å•†åŸç³»çµ±</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2C2F33; color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
    .card { background-color: #23272A; padding: 40px; border-radius: 12px; width: 340px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
    .btn { color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; width: 100%; margin-top: 10px; display: inline-block; box-sizing: border-box; text-decoration: none; }
    .btn-login { background-color: #5865F2; }
    .btn-login:hover { background-color: #4752C4; }
    .btn-buy { background-color: #43B581; }
    .btn-buy:hover { background-color: #3CA374; }
    .btn-logout { background-color: #ED4245; }
    .btn-logout:hover { background-color: #C13537; }
    .avatar { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #5865F2; margin-bottom: 10px; }
    .score-item { display: flex; justify-content: space-between; font-size: 16px; margin: 10px 0; padding-bottom: 6px; border-bottom: 1px solid #4F545C; }
    .score-value { font-weight: bold; color: #58FF9C; }
    .shop-input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #4F545C; background-color: #2C2F33; color: white; box-sizing: border-box; margin-bottom: 10px; font-size: 16px;}
    #dashboard, #loading { display: none; }
  </style>
</head>
<body>

  <div class="card">
    <h1 style="margin-top:0;">ä¼ºæœå™¨ä¸­å¿ƒ</h1>
    
    <div id="login-section">
      <p style="color: #B9BBBE;">è«‹ç¶å®šæ‚¨çš„ Discord å¸³è™Ÿä»¥æŸ¥çœ‹è³‡æ–™èˆ‡å…Œæ›</p>
      <a href="https://discord.com/api/oauth2/authorize?client_id=1365601646448607335&redirect_uri=https%3A%2F%2Fjay870122.github.io%2FDCGI%2F&response_type=token&scope=identify" class="btn btn-login">ğŸ® ä½¿ç”¨ Discord ç™»å…¥</a>
    </div>

    <div id="loading">
      <p id="loading-text">â³ æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>
    </div>

    <div id="dashboard">
      <img id="user-avatar" class="avatar" src="" alt="Avatar">
      <h2 id="user-name" style="margin-top:0;">ç©å®¶åç¨±</h2>
      <div style="background-color: #2C2F33; padding: 15px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
        <div class="score-item"><span>ğŸŒŸ ç¸½ç²å¾—å¹»å½©çµæ™¶:</span> <span class="score-value" id="score-s1">0</span></div>
        <div class="score-item"><span>ğŸ”¥ å¯ç”¨å¹»å½©çµæ™¶:</span> <span class="score-value" id="score-s2">0</span></div>
      </div>

      <h3 style="text-align: left; margin-bottom: 10px;">ğŸ›’ å…Œæ›å•†åº—</h3>
      <div style="background-color: #2C2F33; padding: 15px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
        <label for="shop-items" style="font-size: 14px; color: #B9BBBE;">é¸æ“‡ç‰©å“</label>
        <select id="shop-items" class="shop-input"></select>
        
        <label for="buy-qty" style="font-size: 14px; color: #B9BBBE;">å…Œæ›æ•¸é‡</label>
        <input type="number" id="buy-qty" class="shop-input" value="1" min="1">
        
        <button class="btn btn-buy" onclick="buyItem()">ç¢ºèªå…Œæ›</button>
      </div>

      <button class="btn btn-logout" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</button>
    </div>
  </div>

  <script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzBie8G4KRouJ3nQMsGccDxI0pPlm-kh3Sg8GsURORsRHFCyJgtKV5mJ4A7wKWEo8W1wQ/exec';
    let currentUser = null; 

    window.onload = () => {
      // æŠ“å–ç¶²å€å¾Œé¢çš„ #access_token é€šè¡Œè­‰
      const hashString = window.location.hash.slice(1);
      if (!hashString) return; // å¦‚æœæ²’æœ‰é€šè¡Œè­‰ï¼Œå°±ä¹–ä¹–å¾…åœ¨ç™»å…¥ç•«é¢

      const fragment = new URLSearchParams(hashString);
      const accessToken = fragment.get('access_token');
      const tokenType = fragment.get('token_type');

      if (accessToken) {
        // æˆåŠŸæ‹¿åˆ°é€šè¡Œè­‰ï¼éš±è—ç™»å…¥æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        // ç‚ºäº†ç¾è§€è·Ÿå®‰å…¨ï¼ŒæŠŠç¶²å€ä¸Šçš„äº‚ç¢¼é€šè¡Œè­‰æ“¦æ‰
        window.history.replaceState(null, null, window.location.pathname);

        // å»è·Ÿ Discord æ‹¿é ­åƒè·Ÿåå­—
        fetch('https://discord.com/api/users/@me', { headers: { authorization: `${tokenType} ${accessToken}` } })
        .then(res => res.json())
        .then(user => {
          currentUser = user; 
          document.getElementById('user-name').innerText = user.global_name || user.username;
          document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
          
          fetchScoresAndShop(user.id);
        }).catch(err => {
          console.error("Discord èªè­‰å¤±æ•—:", err);
          alert("ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
          window.location.reload();
        });
      }
    };

    function fetchScoresAndShop(discordId) {
      document.getElementById('loading-text').innerText = "â³ è¼‰å…¥åˆ†æ•¸èˆ‡å•†åº—ç›®éŒ„...";
      
      // æŸ¥åˆ†æ•¸
      fetch(`${GAS_API_URL}?action=getScores&discordId=${discordId}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          document.getElementById('score-s1').innerText = data.s1;
          document.getElementById('score-s2').innerText = data.s2;
          document.getElementById('score-s3').innerText = data.s3;
        }
      }).catch(e => console.error("åˆ†æ•¸è¼‰å…¥éŒ¯èª¤", e));

      // æŸ¥å•†åº—
      fetch(`${GAS_API_URL}?action=getShop`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          const select = document.getElementById('shop-items');
          select.innerHTML = ""; // æ¸…ç©ºèˆŠé¸é …
          data.items.forEach(item => {
            let option = document.createElement('option');
            option.value = item.name;
            option.text = `${item.name} (ğŸ’° ${item.price} å‡éš2)`;
            select.appendChild(option);
          });
          
          // å…¨éƒ¨è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºå„€è¡¨æ¿
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        }
      }).catch(e => console.error("å•†åº—è¼‰å…¥éŒ¯èª¤", e));
    }

    function buyItem() {
      if (!currentUser) return;
      
      const itemName = document.getElementById('shop-items').value;
      const qty = document.getElementById('buy-qty').value;
      
      if (!itemName) {
        alert("ç›®å‰å•†åº—æ²’æœ‰ç‰©å“å¯ä¾›å…Œæ›ï¼");
        return;
      }

      if (!confirm(`ç¢ºå®šè¦èŠ±è²»å‡éš2å…Œæ› ${qty} å€‹ ${itemName} å—ï¼Ÿ`)) return;

      const btn = document.querySelector('.btn-buy');
      btn.innerText = "â³ è™•ç†ä¸­...";
      btn.disabled = true;

      fetch(`${GAS_API_URL}?action=buy&discordId=${currentUser.id}&itemName=${encodeURIComponent(itemName)}&qty=${qty}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          alert("âœ… " + data.message);
          document.getElementById('score-s2').innerText = data.newS2;
        } else {
          alert("âŒ å…Œæ›å¤±æ•—ï¼š" + data.message);
        }
      })
      .catch(err => alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼"))
      .finally(() => {
        btn.innerText = "ç¢ºèªå…Œæ›";
        btn.disabled = false;
      });
    }

    function logout() {
      window.location.href = "https://jay870122.github.io/DCGI/";
    }
  </script>
</body>
</html>
