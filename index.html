var SHEET_ID = '1JlP7BUaD5qzN6hyunzhiuiHNII9AGA1StGL8_xRUFBU'; 
var WEBHOOK_URL = 'https://discord.com/api/webhooks/1474932930886504533/NJKn1q2pFyLK5Z5rvWYEHulLJvnipR7ktvGzebNTi4Elk84MEsmdvbA5OlPfOivDoPlD';

function doGet(e) {
  var action = e.parameter.action || 'getScores';
  var discordId = e.parameter.discordId;
  try {
    if (action === 'getScores') return jsonResponse(getUserScores(discordId));
    else if (action === 'getShop') return jsonResponse(getShopItems(discordId)); 
    else if (action === 'buy') {
      var itemName = e.parameter.itemName;
      var qty = parseInt(e.parameter.qty) || 1;
      return jsonResponse(processPurchase(discordId, itemName, qty));
    }
  } catch (err) { return jsonResponse({ "status": "error", "message": err.toString() }); }
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function getUserScores(discordId) {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var playerSheet = ss.getSheets()[0]; 
  var playerData = playerSheet.getDataRange().getValues();
  
  var s1 = 0, s2 = 0, s3 = 0;
  var playerRow = -1;
  var headers = playerData[0]; 

  for (var i = 1; i < playerData.length; i++) {
    if (playerData[i][0].toString().replace("'", "") === discordId.toString()) {
      playerRow = i;
      s1 = playerData[i][1] || 0;
      s2 = playerData[i][2] || 0;
      s3 = playerData[i][3] || 0;
      break;
    }
  }

  var customVars = [];
  if (ss.getSheets().length >= 4) {
    var varSheet = ss.getSheets()[3];
    var varData = varSheet.getDataRange().getValues();
    for (var v = 1; v < varData.length; v++) {
      var display = varData[v][0];
      var internal = varData[v][1];
      if (display && internal) {
        var val = 0;
        var colIndex = headers.indexOf(internal.toString()); 
        if (colIndex !== -1 && playerRow !== -1) val = playerData[playerRow][colIndex] || 0;
        customVars.push({ display: display, value: val });
      }
    }
  }

  return { "status": "success", "found": playerRow !== -1, "s1": s1, "s2": s2, "s3": s3, "customVars": customVars };
}

function getPurchaseHistory(historyData, discordId, targetItem) {
  var now = new Date();
  var todayStr = Utilities.formatDate(now, "GMT+8", "yyyyMMdd");
  var monthStr = Utilities.formatDate(now, "GMT+8", "yyyyMM");
  var stats = { globalDaily: 0, globalMonthly: 0, personalDaily: 0, personalMonthly: 0, personalTotal: 0 };
  
  for(var r = 1; r < historyData.length; r++) {
    if(historyData[r][2] === targetItem) {
      var tDate = new Date(historyData[r][0]);
      var tId = historyData[r][1].toString().replace("'", "");
      var tQty = parseInt(historyData[r][3]) || 0;
      var tDay = Utilities.formatDate(tDate, "GMT+8", "yyyyMMdd");
      var tMonth = Utilities.formatDate(tDate, "GMT+8", "yyyyMM");
      if(tId === discordId.toString()) stats.personalTotal += tQty;
      if(tMonth === monthStr) {
        stats.globalMonthly += tQty;
        if(tId === discordId.toString()) stats.personalMonthly += tQty;
      }
      if(tDay === todayStr) {
        stats.globalDaily += tQty;
        if(tId === discordId.toString()) stats.personalDaily += tQty;
      }
    }
  }
  return stats;
}

function getShopItems(discordId) {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var sheet = ss.getSheets()[1]; 
  var historySheet = ss.getSheets()[2]; 
  var data = sheet.getDataRange().getValues();
  var historyData = historySheet ? historySheet.getDataRange().getValues() : [];
  var items = [];
  var now = new Date().getTime();

  for (var i = 1; i < data.length; i++) {
    var name = data[i][0];
    if (!name) continue;

    var price = parseInt(data[i][1]) || 0;
    var startDate = data[i][2] ? new Date(data[i][2]).getTime() : null;
    var endDate = data[i][3] ? new Date(data[i][3]).getTime() : null;
    var stockValue = data[i][4];
    var category = data[i][5] ? data[i][5].toString().trim() : 'æœªåˆ†é¡';
    
    var limitGD = data[i][6] !== "" && data[i][6] !== undefined ? parseInt(data[i][6]) : Infinity;
    var limitGM = data[i][7] !== "" && data[i][7] !== undefined ? parseInt(data[i][7]) : Infinity;
    var limitPD = data[i][8] !== "" && data[i][8] !== undefined ? parseInt(data[i][8]) : Infinity;
    var limitPM = data[i][9] !== "" && data[i][9] !== undefined ? parseInt(data[i][9]) : Infinity;
    var limitPT = data[i][10] !== "" && data[i][10] !== undefined ? parseInt(data[i][10]) : Infinity;
    
    // ğŸŒŸ è®€å–è²¨å¹£ç¨®é¡ (L æ¬„)
    var rawCurrency = data[i][11] ? data[i][11].toString().trim() : 'å‡éš2';
    var displayCurrency = (rawCurrency === 'å‡éš2') ? 'å¹»å½©æ°´æ™¶' : rawCurrency;

    var isUnlimitedStock = (!stockValue || stockValue === "" || stockValue === "ç„¡é™" || stockValue === "ç„¡é™åˆ¶");
    var baseStock = isUnlimitedStock ? Infinity : parseInt(stockValue);
    var historyStats = getPurchaseHistory(historyData, discordId, name);
    
    var remainGD = limitGD - historyStats.globalDaily;
    var remainGM = limitGM - historyStats.globalMonthly;
    var remainPD = limitPD - historyStats.personalDaily;
    var remainPM = limitPM - historyStats.personalMonthly;
    var remainPT = limitPT - historyStats.personalTotal;
    
    var effectiveStock = Math.min(baseStock, remainGD, remainGM, remainPD, remainPM, remainPT);
    var state = "available";
    var stateMsg = "å¯å…Œæ›";

    if (startDate && now < startDate) { state = "not_started"; stateMsg = "å°šæœªé–‹å§‹"; } 
    else if (endDate && now > endDate) { state = "ended"; stateMsg = "æ´»å‹•çµæŸ"; } 
    else if (effectiveStock <= 0) { state = "sold_out"; stateMsg = "é”åˆ°ä¸Šé™/å”®å®Œ"; }

    var limitsInfo = {
      baseStock: isUnlimitedStock ? "ç„¡é™" : baseStock,
      remainGD: limitGD === Infinity ? null : remainGD, remainGM: limitGM === Infinity ? null : remainGM,
      remainPD: limitPD === Infinity ? null : remainPD, remainPM: limitPM === Infinity ? null : remainPM,
      remainPT: limitPT === Infinity ? null : remainPT, effectiveStock: effectiveStock === Infinity ? "ç„¡é™" : effectiveStock
    };

    items.push({ 
      name: name, price: price, state: state, stateMsg: stateMsg, 
      category: category, limits: limitsInfo, 
      currency: rawCurrency, displayCurrency: displayCurrency // ğŸŒŸ å°‡è²¨å¹£è³‡è¨Šå‚³çµ¦å‰ç«¯
    });
  }
  return { "status": "success", "items": items };
}

function processPurchase(discordId, itemName, qty) {
  var lock = LockService.getScriptLock();
  lock.waitLock(10000); 
  try {
    var ss = SpreadsheetApp.openById(SHEET_ID);
    var playerSheet = ss.getSheets()[0];
    var shopSheet = ss.getSheets()[1];
    var historySheet = ss.getSheets()[2];
    
    var shopData = shopSheet.getDataRange().getValues();
    var historyData = historySheet.getDataRange().getValues();
    var itemRow = -1;
    var pricePerItem = 0;
    var stockValue = "";
    var currencyName = "å‡éš2"; // é è¨­è²¨å¹£

    var limitGD = Infinity, limitGM = Infinity, limitPD = Infinity, limitPM = Infinity, limitPT = Infinity;

    for (var i = 1; i < shopData.length; i++) {
      if (shopData[i][0] === itemName) {
        itemRow = i + 1;
        pricePerItem = parseInt(shopData[i][1]) || 0;
        var now = new Date().getTime();
        var startDate = shopData[i][2] ? new Date(shopData[i][2]).getTime() : null;
        var endDate = shopData[i][3] ? new Date(shopData[i][3]).getTime() : null;
        if (startDate && now < startDate) return { "status": "error", "message": "æ´»å‹•å°šæœªé–‹å§‹ï¼" };
        if (endDate && now > endDate) return { "status": "error", "message": "æ´»å‹•å·²ç¶“çµæŸï¼" };
        
        stockValue = shopData[i][4];
        limitGD = shopData[i][6] !== "" && shopData[i][6] !== undefined ? parseInt(shopData[i][6]) : Infinity;
        limitGM = shopData[i][7] !== "" && shopData[i][7] !== undefined ? parseInt(shopData[i][7]) : Infinity;
        limitPD = shopData[i][8] !== "" && shopData[i][8] !== undefined ? parseInt(shopData[i][8]) : Infinity;
        limitPM = shopData[i][9] !== "" && shopData[i][9] !== undefined ? parseInt(shopData[i][9]) : Infinity;
        limitPT = shopData[i][10] !== "" && shopData[i][10] !== undefined ? parseInt(shopData[i][10]) : Infinity;
        
        // ğŸŒŸ å–å¾—è©²å•†å“çš„æŒ‡å®šè²¨å¹£
        if (shopData[i][11]) currencyName = shopData[i][11].toString().trim();
        break;
      }
    }

    if (itemRow === -1) return { "status": "error", "message": "æ‰¾ä¸åˆ°è©²å•†å“ï¼" };

    var isUnlimited = (!stockValue || stockValue === "" || stockValue === "ç„¡é™" || stockValue === "ç„¡é™åˆ¶");
    var baseStock = isUnlimited ? Infinity : parseInt(stockValue);
    var historyStats = getPurchaseHistory(historyData, discordId, itemName);
    var remainGD = limitGD - historyStats.globalDaily;
    var remainGM = limitGM - historyStats.globalMonthly;
    var remainPD = limitPD - historyStats.personalDaily;
    var remainPM = limitPM - historyStats.personalMonthly;
    var remainPT = limitPT - historyStats.personalTotal;
    
    var effectiveStock = Math.min(baseStock, remainGD, remainGM, remainPD, remainPM, remainPT);
    if (effectiveStock < qty) { return { "status": "error", "message": "è¶…éé™è³¼æ•¸é‡æˆ–åº«å­˜ä¸è¶³ï¼" }; }

    // ğŸŒŸ å‹•æ…‹å°‹æ‰¾ç©å®¶çš„è²¨å¹£æ¬„ä½
    var totalCost = pricePerItem * qty;
    var playerData = playerSheet.getDataRange().getValues();
    var playerHeaders = playerData[0];
    var currencyColIndex = playerHeaders.indexOf(currencyName);
    
    if (currencyColIndex === -1) {
      return { "status": "error", "message": "ç³»çµ±éŒ¯èª¤ï¼šç©å®¶åº«æ‰¾ä¸åˆ°è²¨å¹£ [" + currencyName + "]" };
    }

    var playerRow = -1;
    var currentBalance = 0;
    for (var i = 1; i < playerData.length; i++) {
      if (playerData[i][0].toString().replace("'", "") === discordId.toString()) {
        playerRow = i + 1; 
        currentBalance = parseInt(playerData[i][currencyColIndex]) || 0; 
        break;
      }
    }

    if (playerRow === -1) return { "status": "error", "message": "æ‰¾ä¸åˆ°æ‚¨çš„å¸³è™Ÿè³‡æ–™" };
    
    var displayCurrencyName = (currencyName === 'å‡éš2') ? 'å¹»å½©æ°´æ™¶' : currencyName;
    if (currentBalance < totalCost) return { "status": "error", "message": displayCurrencyName + " é¤˜é¡ä¸è¶³ï¼(éœ€è¦ " + totalCost + ")" };

    // ğŸŒŸ å‹•æ…‹æ‰£æ¬¾å¯«å…¥å°æ‡‰çš„æ¬„ä½ï¼
    playerSheet.getRange(playerRow, currencyColIndex + 1).setValue(currentBalance - totalCost);
    
    if (!isUnlimited) shopSheet.getRange(itemRow, 5).setValue(baseStock - qty); 
    historySheet.appendRow([new Date(), discordId.toString(), itemName, qty]);

    // ğŸŒŸ Discord å»£æ’­åŠ å…¥å‹•æ…‹è²¨å¹£åç¨±ï¼
    var msg = "[è³¼è²·] ç©å®¶ " + discordId + " è³¼è²·äº† " + qty + " å€‹ã€" + itemName + "ã€‘ï¼Œå…±èŠ±è²» " + totalCost + " " + displayCurrencyName;
    var payload = { "content": msg };
    var options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload) };
    try { UrlFetchApp.fetch(WEBHOOK_URL, options); } catch(e) {}

    return { "status": "success", "message": "å…Œæ›æˆåŠŸï¼" }; // å› ç‚ºå¯èƒ½æ‰£çš„æ˜¯åˆ¥çš„éŒ¢ï¼Œå‰ç«¯ç›´æ¥æ•´é é‡æ–°æ•´ç†æœ€å®‰å…¨
  } finally { lock.releaseLock(); }
}

// ğŸŒŸ å¿…é ˆä¿ç•™ï¼šæ¥æ”¶ Skript åŒæ­¥è³‡æ–™çš„å‡½æ•¸
function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.waitLock(10000); 
  try {
    var data = JSON.parse(e.postData.contents);
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheets()[0]; 
    var sheetData = sheet.getDataRange().getValues();
    var headers = sheetData[0]; 

    var playerMap = {};
    for (var i = 1; i < sheetData.length; i++) {
      var idStr = sheetData[i][0].toString().replace("'", "");
      playerMap[idStr] = i + 1; 
    }

    for (var j = 0; j < data.length; j++) {
      var p = data[j];
      var row = playerMap[p.discordId.toString()];
      
      if (!row) {
        var newRowData = new Array(headers.length).fill("");
        newRowData[0] = "'" + p.discordId;
        sheet.appendRow(newRowData);
        row = sheet.getLastRow();
        playerMap[p.discordId.toString()] = row;
      }

      if (p.score1 !== undefined) sheet.getRange(row, 2).setValue(p.score1);
      if (p.score2 !== undefined) sheet.getRange(row, 3).setValue(p.score2);
      if (p.score3 !== undefined) sheet.getRange(row, 4).setValue(p.score3);

      if (p.custom) {
        for (var key in p.custom) {
          var colIndex = headers.indexOf(key);
          if (colIndex === -1) {
            colIndex = headers.length;
            headers.push(key);
            sheet.getRange(1, colIndex + 1).setValue(key);
          }
          sheet.getRange(row, colIndex + 1).setValue(p.custom[key]);
        }
      }
    }
    return ContentService.createTextOutput("Sync Success (Multi-Currency Enabled)");
  } catch (err) {
    return ContentService.createTextOutput("Sync Error: " + err.toString());
  } finally {
    lock.releaseLock();
  }
}
