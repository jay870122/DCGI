<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garbled å¹»å½©æ°´æ™¶å•†åº—</title>
  <style>
    /* ğŸŒŸ æ•´é«”ç‰ˆé¢èˆ‡å¯¬åº¦è¨­å®š */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2C2F33; color: white; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
    .card { background-color: #23272A; padding: 30px; border-radius: 12px; width: 100%; max-width: 1100px; box-shadow: 0 8px 20px rgba(0,0,0,0.6); position: relative; }
    
    /* ğŸŒŸ æŒ‰éˆ•æ¨£å¼ */
    .btn { color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; width: 100%; display: inline-block; box-sizing: border-box; text-decoration: none; text-align: center;}
    .btn-login { background-color: #5865F2; margin-top: 10px; max-width: 300px; }
    .btn-login:hover { background-color: #4752C4; }
    .btn-logout { background-color: #ED4245; margin-top: 20px; max-width: 200px;}
    .btn-logout:hover { background-color: #C13537; }
    .btn-action { background-color: #4F545C; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.3s; }
    .btn-action:hover { background-color: #686D73; }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* ğŸŒŸ ç©å®¶é ‚éƒ¨æ©«å‘è³‡è¨Šå€å¡Š */
    .user-header-section { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background-color: #2C2F33; padding: 20px; border-radius: 8px; flex-wrap: wrap; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #5865F2; flex-shrink: 0;}
    .user-info { flex-grow: 1; }
    .score-box { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 8px; }
    .score-item { font-size: 15px; background: #202225; padding: 6px 12px; border-radius: 6px; border: 1px solid #4F545C; display: flex; align-items: center; gap: 6px;}
    .score-value { font-weight: bold; color: #58FF9C; }
    .dynamic-score-value { font-weight: bold; color: #FEE75C; } 
    
    /* ğŸŒŸ å´é‚Šæ¬„èˆ‡ç¶²æ ¼å•†å“å€ä½ˆå±€ */
    .shop-layout { display: flex; gap: 20px; align-items: flex-start; }
    .sidebar { width: 220px; flex-shrink: 0; background-color: #2C2F33; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 5px; position: sticky; top: 20px; }
    .cat-item { padding: 12px 15px; border-radius: 6px; cursor: pointer; color: #B9BBBE; font-size: 15px; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .cat-item:hover { background-color: #40444B; color: white; }
    .cat-item.active { background-color: #5865F2; color: white; font-weight: bold; }
    
    .main-area { flex-grow: 1; width: 100%; min-width: 0; }
    .controls-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background-color: #2C2F33; padding: 10px 15px; border-radius: 8px; }
    .shop-input { padding: 8px 12px; border-radius: 5px; border: 1px solid #4F545C; background-color: #202225; color: white; font-size: 14px; outline: none; }
    
    /* ğŸŒŸ å•†å“ç¶²æ ¼å¡ç‰‡ */
    .shop-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .shop-item-card { background-color: #2F3136; border: 1px solid #4F545C; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden; height: 100%; box-sizing: border-box; }
    .shop-item-card.disabled { opacity: 0.6; }
    
    .item-image { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; margin-bottom: 12px; border: 1px solid #40444B; }
    .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #40444B; padding-bottom: 8px; gap: 10px;}
    .item-name { font-size: 18px; font-weight: bold; color: #FFF; line-height: 1.3;}
    .item-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: bold; flex-shrink: 0; white-space: nowrap; }
    .badge-avail { background-color: #43B581; color: white; }
    .badge-unavail { background-color: #ED4245; color: white; }
    .item-remark { font-size: 13px; color: #99AAB5; margin-bottom: 12px; padding: 8px; background-color: #202225; border-left: 3px solid #5865F2; border-radius: 4px; line-height: 1.4; white-space: pre-wrap; }
    .item-info { font-size: 14px; color: #B9BBBE; margin-bottom: 15px; line-height: 1.6; flex-grow: 1; } 
    .item-price { color: #FEE75C; font-weight: bold; font-size: 16px; }
    
    .limit-tags { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .limit-tag { font-size: 12px; padding: 4px 8px; border-radius: 4px; display: inline-block; width: fit-content; }
    .tag-global { background-color: #4F545C; color: #FFF; }
    .tag-personal { background-color: #5865F2; color: #FFF; }
    .tag-total { background-color: #FEE75C; color: #000; font-weight: bold; }

    .item-actions { display: flex; gap: 10px; align-items: center; margin-top: auto; }
    .qty-input { width: 70px; padding: 8px; border-radius: 6px; border: 1px solid #4F545C; background-color: #202225; color: white; font-size: 16px; text-align: center; outline: none; }
    .btn-buy { background-color: #43B581; padding: 8px 16px; width: auto; flex-grow: 1; }
    .btn-buy:hover { background-color: #3CA374; }
    .btn-buy:disabled { background-color: #4F545C; cursor: not-allowed; }

    /* æ‰‹æ©Ÿç‰ˆé©æ‡‰ï¼šå´é‚Šæ¬„è®Šç‚ºä¸Šæ–¹æ©«å‘æ²å‹• */
    @media (max-width: 768px) {
      .shop-layout { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; position: static; white-space: nowrap; padding: 10px; box-sizing: border-box; }
      .cat-item { flex-shrink: 0; }
    }

    /* ğŸŒŸ å½ˆå‡ºè¦–çª— (æ­·å²ç´€éŒ„) */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box;}
    .modal-content { background: #2F3136; border-radius: 12px; padding: 25px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto; text-align: left; position: relative;}
    .modal-close { position: absolute; top: 15px; right: 20px; color: #B9BBBE; font-size: 24px; font-weight: bold; cursor: pointer; }
    .modal-close:hover { color: white; }
    .history-card { background: #202225; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #40444B;}
    .history-time { font-size: 12px; color: #72767D; margin-bottom: 5px; }
    .history-name { font-size: 16px; font-weight: bold; color: #FFF; }
    .history-qty { color: #A6D189; }
    .history-keys { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #4F545C; color: #FEE75C; font-family: monospace; font-size: 14px; word-break: break-all;}

    .version-tag { font-size: 12px; color: #72767D; margin-top: 20px; text-align: center; }
    #dashboard, #loading { display: none; }
  </style>
</head>
<body>

  <div id="history-modal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeHistory()">Ã—</span>
      <h2 style="margin-top:0; border-bottom: 1px solid #4F545C; padding-bottom: 10px;">ğŸ“œ å…Œæ›èˆ‡åºè™Ÿç´€éŒ„</h2>
      <div id="history-list-container">
        <p style="text-align:center; color:#B9BBBE;">è®€å–ä¸­...</p>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="login-section" style="text-align: center;">
      <h1 style="margin-top:0;">Garbled å¹»å½©æ°´æ™¶å•†åº—</h1>
      <p style="color: #B9BBBE;">è«‹ç¶å®šæ‚¨çš„ Discord å¸³è™Ÿä»¥æŸ¥çœ‹è³‡æ–™èˆ‡å…Œæ›</p>
      <a href="https://discord.com/api/oauth2/authorize?client_id=1365601646448607335&redirect_uri=https%3A%2F%2Fjay870122.github.io%2FDCGI%2F&response_type=token&scope=identify" class="btn btn-login">ğŸ® ä½¿ç”¨ Discord ç™»å…¥</a>
    </div>

    <div id="loading" style="text-align: center;">
      <p id="loading-text" style="font-size: 18px;">â³ æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>
    </div>

    <div id="dashboard">
      
      <div class="user-header-section">
        <img id="user-avatar" class="avatar" src="" alt="Avatar">
        <div class="user-info">
          <h2 id="user-name" style="margin: 0 0 5px 0;">ç©å®¶åç¨±</h2>
          <div class="score-box" id="score-box-container">
            <div class="score-item">ğŸŒŸ ç¸½ç²å¾—: <span class="score-value" id="score-s1">0</span></div>
            <div class="score-item">ğŸ”¥ å¹»å½©æ°´æ™¶: <span class="score-value" id="score-s2">0</span></div>
            <div class="score-item" id="score-s3-container">ğŸ’ é»æ•¸3: <span class="score-value" id="score-s3">0</span></div>
          </div>
        </div>
        <div style="display: flex; gap: 10px; flex-direction: column;">
          <button class="btn-action" onclick="showHistory()" style="background-color: #5865F2;">ğŸ“œ æˆ‘çš„ç´€éŒ„</button>
          <button class="btn-action" onclick="logout()" style="background-color: #ED4245;">ç™»å‡ºå¸³è™Ÿ</button>
        </div>
      </div>

      <div class="shop-layout">
        <div class="sidebar" id="category-sidebar"></div>
        
        <div class="main-area">
          <div class="controls-container">
            <h3 style="margin: 0;">ğŸ›’ å…Œæ›å•†åº—</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="sort-items" class="shop-input" onchange="renderShop()">
                <option value="default">é è¨­æ’åº</option>
                <option value="avail-first">âœ… å¯ç”¨å„ªå…ˆ</option>
                <option value="price-low">ğŸ’° åƒ¹æ ¼ ä½ ~ é«˜</option>
                <option value="price-high">ğŸ’° åƒ¹æ ¼ é«˜ ~ ä½</option>
              </select>
              <button id="btn-refresh" class="btn-action" onclick="refreshData()">ğŸ”„ é‡æ•´åº«å­˜</button>
            </div>
          </div>
          <div id="shop-list" class="shop-list-container"></div>
        </div>
      </div>
    </div>

    <div class="version-tag">ç³»çµ±ç‰ˆæœ¬ï¼šv2.3.0 (å°Šæ¦® VIP æ¢ä»¶é©—è­‰ç‰ˆ)</div>
  </div>

  <script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzBie8G4KRouJ3nQMsGccDxI0pPlm-kh3Sg8GsURORsRHFCyJgtKV5mJ4A7wKWEo8W1wQ/exec';
    let currentUser = null; 
    let currentShopItems = []; 
    let currentCategory = 'all'; 

    window.onload = () => {
      // ğŸŒŸ è™•ç† Discord ç™»å…¥ç‹€æ…‹ä¿æŒ
      const hashString = window.location.hash.slice(1);
      let accessToken = null; let tokenType = null;
      if (hashString) {
        const fragment = new URLSearchParams(hashString);
        accessToken = fragment.get('access_token'); tokenType = fragment.get('token_type');
        if (accessToken) {
          localStorage.setItem('dc_access_token', accessToken); localStorage.setItem('dc_token_type', tokenType);
          window.history.replaceState(null, null, window.location.pathname);
        }
      } else {
        accessToken = localStorage.getItem('dc_access_token'); tokenType = localStorage.getItem('dc_token_type');
      }

      if (accessToken) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        fetch('https://discord.com/api/users/@me', { headers: { authorization: `${tokenType} ${accessToken}` } })
        .then(res => { if (!res.ok) throw new Error('ç™»å…¥éæœŸ'); return res.json(); })
        .then(user => {
          currentUser = user; 
          document.getElementById('user-name').innerText = user.global_name || user.username;
          document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
          fetchScoresAndShop(user.id);
        }).catch(err => {
          localStorage.removeItem('dc_access_token'); localStorage.removeItem('dc_token_type');
          document.getElementById('loading').style.display = 'none'; document.getElementById('login-section').style.display = 'block';
        });
      }
    };

    function refreshData() {
      if(!currentUser) return;
      const refreshBtn = document.getElementById('btn-refresh');
      refreshBtn.innerText = "â³..."; refreshBtn.disabled = true;
      fetchScoresAndShop(currentUser.id, () => { refreshBtn.innerText = "ğŸ”„ é‡æ•´åº«å­˜"; refreshBtn.disabled = false; });
    }

    // ğŸŒŸ å·¦å´é‚Šæ¬„é¸æ“‡é‚è¼¯
    function selectCategory(cat) {
      currentCategory = cat;
      renderSidebar();
      renderShop();   
    }

    function renderSidebar() {
      const catSet = new Set(currentShopItems.map(item => item.category));
      const sidebar = document.getElementById('category-sidebar');
      let html = `<div class="cat-item ${currentCategory === 'all' ? 'active' : ''}" onclick="selectCategory('all')"><span>ğŸ“ æ‰€æœ‰å•†å“</span></div>`;
      catSet.forEach(cat => {
        const count = currentShopItems.filter(i => i.category === cat).length;
        html += `<div class="cat-item ${currentCategory === cat ? 'active' : ''}" onclick="selectCategory('${cat}')">
                   <span>ğŸ·ï¸ ${cat}</span><span style="font-size:12px; opacity:0.7;">${count}</span>
                 </div>`;
      });
      sidebar.innerHTML = html;
    }

    // ğŸŒŸ æ­·å²ç´€éŒ„è®€å–é‚è¼¯ (é˜²æ•¸å­—å ±éŒ¯)
    function showHistory() {
      if(!currentUser) return;
      const modal = document.getElementById('history-modal');
      const container = document.getElementById('history-list-container');
      modal.style.display = 'flex';
      container.innerHTML = '<p style="text-align:center; color:#B9BBBE;">è®€å–è³‡æ–™ä¸­...</p>';

      fetch(`${GAS_API_URL}?action=getHistory&discordId=${currentUser.id}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success" && data.history.length > 0) {
          container.innerHTML = "";
          data.history.forEach(record => {
            let keyHtml = "";
            if(record.keys && record.keys !== "ç„¡") {
              let safeKeys = String(record.keys); 
              keyHtml = `<div class="history-keys">ğŸ åºè™Ÿï¼š<br>${safeKeys.split(', ').join('<br>')}</div>`;
            }
            // è‹¥ç‚ºæ¢ä»¶å•†å“ï¼Œéš±è—åç¨±ä¸­çš„ [æŒæœ‰]
            // ğŸŒŸ é †æ‰‹æŠŠ [éš±è—] æ¨™ç±¤ä¹Ÿå¾æ­·å²ç´€éŒ„çš„é¡¯ç¤ºä¸­æ“¦æ‰
            let displayName = record.itemName.replace('[æŒæœ‰]', '').replace('[éš±è—]', '').trim();
            container.innerHTML += `<div class="history-card"><div class="history-time">${record.time}</div><div class="history-name">${displayName} <span class="history-qty">x ${record.qty}</span></div>${keyHtml}</div>`;
          });
        } else { container.innerHTML = '<p style="text-align:center; color:#B9BBBE;">ç›®å‰å°šç„¡å…Œæ›ç´€éŒ„</p>'; }
      }).catch(err => {
        console.error("æ­·å²ç´€éŒ„è®€å–éŒ¯èª¤:", err); 
        container.innerHTML = '<p style="text-align:center; color:#ED4245;">è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
      });
    }

    function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }

    function fetchScoresAndShop(discordId, callback = null) {
      document.getElementById('loading-text').innerText = "â³ è¼‰å…¥åˆ†æ•¸èˆ‡å•†åº—ç›®éŒ„...";
      
      let p1 = fetch(`${GAS_API_URL}?action=getScores&discordId=${discordId}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          document.getElementById('score-s1').innerText = data.s1;
          document.getElementById('score-s2').innerText = data.s2;
          document.getElementById('score-s3').innerText = data.s3;
          if (parseInt(data.s3) === 0) document.getElementById('score-s3-container').style.display = 'none';
          else document.getElementById('score-s3-container').style.display = 'flex';

          document.querySelectorAll('.dynamic-score-item').forEach(e => e.remove());
          if(data.customVars && data.customVars.length > 0) {
            const container = document.getElementById('score-box-container');
            data.customVars.forEach(v => {
              container.insertAdjacentHTML('beforeend', `<div class="score-item dynamic-score-item">ğŸ’  ${v.display}: <span class="dynamic-score-value">${v.value}</span></div>`);
            });
          }
        }
      });

let p2 = fetch(`${GAS_API_URL}?action=getShop&discordId=${discordId}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          // ğŸŒŸ éš±è—é­”æ³•ï¼šç›´æ¥æŠŠåç¨±åŒ…å« [éš±è—] çš„å•†å“å¾æ¸…å–®ä¸­å‰”é™¤ï¼
          currentShopItems = data.items.filter(item => !item.name.includes('[éš±è—]'));
          
          renderSidebar(); 
          renderShop();    
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        }
      });

      Promise.all([p1, p2]).then(() => { if(callback) callback(); });
    }

    function renderShop() {
      const container = document.getElementById('shop-list');
      const sortType = document.getElementById('sort-items').value;
      let displayItems = [...currentShopItems];

      if (currentCategory !== 'all') displayItems = displayItems.filter(item => item.category === currentCategory);

      if (sortType === 'avail-first') {
        displayItems.sort((a, b) => {
          if (a.state === 'available' && b.state !== 'available') return -1;
          if (a.state !== 'available' && b.state === 'available') return 1;
          return 0;
        });
      } else if (sortType === 'price-low') displayItems.sort((a, b) => a.price - b.price);
      else if (sortType === 'price-high') displayItems.sort((a, b) => b.price - a.price);

      container.innerHTML = "";
      if (displayItems.length === 0) {
        container.innerHTML = "<div style='color:#B9BBBE; padding: 20px;'>æ­¤åˆ†é¡ç›®å‰ç„¡å•†å“</div>";
        return;
      }

      displayItems.forEach((item) => {
        const isAvail = item.state === "available";
        const badgeClass = isAvail ? "badge-avail" : "badge-unavail";
        const safeId = "item-" + item.id; 
        
        let limitsHtml = `<div class="limit-tags">`;
        if (item.limits.remainGD !== null) limitsHtml += `<span class="limit-tag tag-global">ğŸŒ å…¨æœä»Šæ—¥: ${item.limits.remainGD}</span>`;
        if (item.limits.remainGM !== null) limitsHtml += `<span class="limit-tag tag-global">ğŸŒ å…¨æœæœ¬æœˆ: ${item.limits.remainGM}</span>`;
        if (item.limits.remainPD !== null) limitsHtml += `<span class="limit-tag tag-personal">ğŸ‘¤ å€‹äººä»Šæ—¥: ${item.limits.remainPD}</span>`;
        if (item.limits.remainPM !== null) limitsHtml += `<span class="limit-tag tag-personal">ğŸ‘¤ å€‹äººæœ¬æœˆ: ${item.limits.remainPM}</span>`;
        if (item.limits.remainPT !== null) limitsHtml += `<span class="limit-tag tag-total">ğŸ‘‘ çµ‚èº«é™è³¼: ${item.limits.remainPT}</span>`;
        limitsHtml += `</div>`;
        if (limitsHtml === `<div class="limit-tags"></div>`) limitsHtml = ""; 

        // ğŸŒŸ è™•ç†åœ–æ–‡é¡¯ç¤ºèˆ‡ [æŒæœ‰] æ¨™ç±¤é‚è¼¯
        let isHold = item.name.includes('[æŒæœ‰]');
        let displayName = item.name.replace('[æŒæœ‰]', '').trim();

        let imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" class="item-image" alt="å•†å“åœ–ç‰‡">` : '';
        let remarkHtml = item.remark ? `<div class="item-remark">ğŸ“ ${item.remark}</div>` : '';

        let actionHtml = '';
        if (isAvail) {
          let maxQty = item.limits.effectiveStock !== "ç„¡é™" ? item.limits.effectiveStock : 999;
          actionHtml = `
            <div class="item-actions">
              <input type="number" id="qty-${safeId}" class="qty-input" value="1" min="1" max="${maxQty}">
              <button id="btn-${safeId}" class="btn btn-buy" onclick="buyItem(${item.id}, '${item.name}', '${safeId}', ${maxQty}, '${item.displayCurrency}')">å…Œæ›</button>
            </div>
          `;
        } else {
          actionHtml = `<div class="item-actions"><button class="btn btn-buy" disabled>ç„¡æ³•å…Œæ›</button></div>`;
        }

        const html = `
          <div class="shop-item-card ${!isAvail ? 'disabled' : ''}">
            ${imageHtml}
            <div class="item-header">
              <span class="item-name">${displayName}</span>
              <span class="item-badge ${badgeClass}">${item.stateMsg}</span>
            </div>
            ${remarkHtml}
            <div class="item-info">
              ${isHold ? 
                `âœ¨ æ¢ä»¶ï¼š<span class="item-price" style="color:#58FF9C;">éœ€æŒæœ‰ ${item.price} ${item.displayCurrency}</span><br>` : 
                `ğŸ’° åƒ¹æ ¼ï¼š<span class="item-price">${item.price} ${item.displayCurrency}</span><br>`}
              ğŸ“¦ åº«å­˜ï¼š${item.limits.baseStock}
              ${limitsHtml}
            </div>
            ${actionHtml}
          </div>
        `;
        container.innerHTML += html;
      });
    }

    function buyItem(itemId, itemName, safeId, maxQty, currencyName) {
      if (!currentUser) return;
      const qtyInput = document.getElementById(`qty-${safeId}`);
      const qty = parseInt(qtyInput.value);
      
      if (qty < 1) { alert("æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼"); return; }
      if (qty > maxQty) { alert(`å·²è¶…éé™è³¼æ•¸é‡ï¼æ‚¨ç›®å‰æœ€å¤šåªèƒ½è²· ${maxQty} å€‹ã€‚`); return; }
      
      // ğŸŒŸ [æŒæœ‰] ç¢ºèªè¦–çª—é‚è¼¯
      let isHold = itemName.includes('[æŒæœ‰]');
      let displayItemName = itemName.replace('[æŒæœ‰]', '').trim();

      let confirmMsg = isHold 
        ? `ğŸ æ­¤ç‚ºæ¢ä»¶ç¦åˆ©ï¼\n\nç³»çµ±åƒ…æœƒé©—è­‰æ‚¨æ˜¯å¦æŒæœ‰è¶³å¤ çš„ã€${currencyName}ã€‘ä½œç‚ºé ˜å–æ¢ä»¶ï¼Œå¯¦éš›æ‰£æ¬¾ç‚º 0ã€‚\nç¢ºå®šè¦é ˜å– ${qty} å€‹ ${displayItemName} å—ï¼Ÿ` 
        : `ç¢ºå®šè¦èŠ±è²» ${currencyName} å…Œæ› ${qty} å€‹ ${displayItemName} å—ï¼Ÿ`;
        
      if (!confirm(confirmMsg)) return;

      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading-text').innerText = "â³ æ­£åœ¨è™•ç†è¨‚å–®...";

fetch(`${GAS_API_URL}?action=buy&discordId=${currentUser.id}&itemId=${itemId}&itemName=${encodeURIComponent(itemName)}&qty=${qty}`)
      .then(res => res.json())
      .then(data => {
        if(data.status === "success") {
          let successMsg = "âœ… å…Œæ›èˆ‡è™•ç†å®Œæˆï¼";
          
          // ğŸŒŸ å¦‚æœæœ‰æŠ½åˆ°è®Šæ•¸çå‹µï¼Œç›´æ¥åœ¨ç•«é¢ä¸Šæ”¾ç…™ç«
          if (data.rewardVar && data.totalReward > 0) {
            successMsg += `\n\nğŸ‰ æ­å–œæ‚¨é–‹å‡ºäº†ï¼šã€ ${data.totalReward} é» ${data.rewardVar} ã€‘ï¼`;
          }

          // åºè™Ÿçå‹µ
          if (data.keys && data.keys.length > 0) {
            successMsg += "\n\nğŸ æ‚¨ç²å¾—çš„å°ˆå±¬åºè™Ÿï¼š\n" + data.keys.join("\n") + "\n\n(å¯è‡³ã€Œç´€éŒ„ã€éš¨æ™‚æŸ¥è©¢)";
          }
          
          alert(successMsg);
          fetchScoresAndShop(currentUser.id); 
        } else {
          alert("âŒ å…Œæ›å¤±æ•—ï¼š" + data.message);
          // ğŸŒŸ åº«å­˜è®Šå‹•å°è‡´å¤±æ•—æ™‚ï¼Œè‡ªå‹•é‡æ•´é˜²å‘†
          if (data.message.includes("åº«å­˜") || data.message.includes("é™è³¼") || data.message.includes("å”®å®Œ") || data.message.includes("ä¸Šé™")) {
            document.getElementById('loading-text').innerText = "ğŸ”„ æ­£åœ¨åŒæ­¥æœ€æ–°å•†åŸåº«å­˜...";
            fetchScoresAndShop(currentUser.id);
          } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
          }
        }
      })
      .catch(err => {
        alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
      });
    }

    function logout() {
      localStorage.removeItem('dc_access_token'); localStorage.removeItem('dc_token_type');
      window.location.href = "https://jay870122.github.io/DCGI/";
    }
  </script>
</body>
</html>
