<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ›¼é¯Šé¯Š | ç©å®¶é»æ•¸æŸ¥è©¢</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2C2F33; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    .card { background-color: #23272A; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
    .btn-login { background-color: #5865F2; color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; display: inline-block; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
    .btn-login:hover { background-color: #4752C4; }
    .avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #5865F2; margin-bottom: 15px; }
    .score-item { display: flex; justify-content: space-between; font-size: 18px; margin: 12px 0; padding-bottom: 8px; border-bottom: 1px solid #4F545C; }
    .score-value { font-weight: bold; color: #58FF9C; }
    #dashboard, #loading { display: none; } /* é è¨­éš±è—å„€è¡¨æ¿å’Œè¼‰å…¥ä¸­ */
  </style>
</head>
<body>

  <div class="card">
    <h1 style="margin-top:0;">ä¼ºæœå™¨é»æ•¸æŸ¥è©¢</h1>
    
    <div id="login-section">
      <p style="color: #B9BBBE;">è«‹ç¶å®šæ‚¨çš„ Discord å¸³è™Ÿä»¥æŸ¥çœ‹æœ€æ–°è³‡æ–™</p>
      <button class="btn-login" onclick="loginWithDiscord()">ğŸ® ä½¿ç”¨ Discord ç™»å…¥</button>
    </div>

    <div id="loading">
      <p>â³ æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«è®€å–æ‚¨çš„åˆ†æ•¸...</p>
    </div>

    <div id="dashboard">
      <img id="user-avatar" class="avatar" src="" alt="Avatar">
      <h2 id="user-name">ç©å®¶åç¨±</h2>
      <div style="background-color: #2C2F33; padding: 15px; border-radius: 8px; text-align: left;">
        <div class="score-item"><span>ğŸŒŸ å‡éš1:</span> <span class="score-value" id="score-s1">0</span></div>
        <div class="score-item"><span>ğŸ”¥ å‡éš2:</span> <span class="score-value" id="score-s2">0</span></div>
        <div class="score-item"><span>ğŸ’ é»æ•¸3:</span> <span class="score-value" id="score-s3">0</span></div>
      </div>
      <button class="btn-login" style="background-color: #ED4245; width: 100%; box-sizing: border-box;" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <script>
    // ==========================================
    // ğŸ”§ è¨­å®šå€ (è«‹å¡«å…¥ä½ è‡ªå·±çš„è³‡æ–™)
    // ==========================================
    const CLIENT_ID = '1365601646448607335'; 
    const REDIRECT_URI = encodeURIComponent('https://script.google.com/macros/s/AKfycbzBie8G4KRouJ3nQMsGccDxI0pPlm-kh3Sg8GsURORsRHFCyJgtKV5mJ4A7wKWEo8W1wQ/exec'); // ä½ çš„ GitHub Pages ç¶²å€
    const GAS_API_URL = 'ä½ çš„GAS_APIç¶²å€(çµå°¾æ˜¯/execçš„é‚£å€‹)';

    // ==========================================
    // ğŸš€ æ ¸å¿ƒé‚è¼¯
    // ==========================================
    
    // 1. é»æ“Šç™»å…¥æ™‚ï¼Œè·³è½‰åˆ° Discord æˆæ¬Šç•«é¢ (æ³¨æ„ response_type=token)
    function loginWithDiscord() {
      const oauthUrl = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=identify`;
      window.location.href = oauthUrl;
    }

    // 2. ç¶²é è¼‰å…¥æ™‚ï¼Œæª¢æŸ¥ç¶²å€è£¡é¢æœ‰æ²’æœ‰ Discord å‚³å›ä¾†çš„ Token
    window.onload = () => {
      const fragment = new URLSearchParams(window.location.hash.slice(1));
      const [accessToken, tokenType] = [fragment.get('access_token'), fragment.get('token_type')];

      if (accessToken) {
        // ç‚ºäº†å®‰å…¨ï¼ŒæŠŠç¶²å€ä¸Šçš„ Token æ“¦æ‰ï¼Œé¿å…ç©å®¶æˆªåœ–å¤–æ´©
        window.history.replaceState(null, null, window.location.pathname);
        
        // åˆ‡æ›ç•«é¢ï¼šéš±è—ç™»å…¥æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        // å»è·Ÿ Discord æ‹¿ç©å®¶çš„å€‹äººè³‡æ–™
        fetch('https://discord.com/api/users/@me', {
          headers: { authorization: `${tokenType} ${accessToken}` }
        })
        .then(result => result.json())
        .then(user => {
          // é¡¯ç¤ºå¤§é ­è²¼å’Œåå­—
          document.getElementById('user-name').innerText = user.global_name || user.username;
          document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
          
          // æ‹¿åˆ°äº† Discord IDï¼Œç¾åœ¨å»æ•²æˆ‘å€‘çš„ GAS API æŸ¥åˆ†æ•¸ï¼
          fetchScoresFromGAS(user.id);
        })
        .catch(console.error);
      }
    };

    // 3. å» GAS API æŸ¥åˆ†æ•¸
    function fetchScoresFromGAS(discordId) {
      fetch(`${GAS_API_URL}?discordId=${discordId}`, {
        method: 'GET',
        redirect: 'follow'
      })
      .then(response => response.json())
      .then(data => {
        if(data.status === "success") {
          // æŠŠåˆ†æ•¸å¡«å…¥ç•«é¢
          document.getElementById('score-s1').innerText = data.s1;
          document.getElementById('score-s2').innerText = data.s2;
          document.getElementById('score-s3').innerText = data.s3;
          
          // åˆ‡æ›ç•«é¢ï¼šéš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºå„€è¡¨æ¿
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
        } else {
          alert('è®€å–åˆ†æ•¸å¤±æ•—ï¼š' + data.message);
        }
      })
      .catch(error => {
        alert('ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼');
        console.error(error);
      });
    }

    // 4. ç™»å‡º
    function logout() {
      window.location.reload(); // ç°¡å–®æš´åŠ›ï¼Œé‡æ•´é é¢å°±æ¸…ç©ºç‹€æ…‹äº†
    }
  </script>
</body>
</html>
